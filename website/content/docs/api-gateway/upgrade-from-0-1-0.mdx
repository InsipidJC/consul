---
layout: docs
page_title: Upgrading from v0.1.0
description: >-
  Consul api gateway versions v0.2.x introduced a change to namespace backend ref
  enforcement that will potentially break any routes created with a cross namespace in
  v0.1.0. This documents the flow for finding and remediating any potentially
  broken routes
---

# Upgrading from v0.1.0


## Introduction

This guide explains how to best upgrade a consul-api-gateway deployment that is currently
running v0.1.0 to all future versions. v0.2.0 introduced a breaking change that
causes routes defined with a BackendRef defined in a different namespace to
require a [ReferencePolicy](https://gateway-api.sigs.k8s.io/v1alpha2/references/spec/#gateway.networking.k8s.io/v1alpha2.ReferencePolicy)
that explicitly allows traffic from the routes namespace to the backendrefs namespace.



## Requirements

- The consul-api-gateway should be running version v0.1.0, if the version is different, follow the normal upgrade path
- (jq)[https://stedolan.github.io/jq/download/] is installed on the users CLI

Note, as of writing, this is the only upgrade path documented as v0.1.0 is the only currently released version. Normal upgrade path will be documented
in future releases

## Assumptions

This guides makes the following assumptions:

- You have the ability to run Kubectl cli commands
- Your kubectl config is already configured to point at the cluster with the installation you are upgrading
- You have HTTPRoute.read, TCPRoute.read and ReferencePolicy.create rights on your kubernetes cluster


## Procedures

**1.** Optional, double check the current version of the consul-api-gateway with the following command

```kubectl get deployment --namespace consul consul-api-gateway-controller -o json | jq '.spec.template.spec.containers[] | select(.name="api-gateway-controller") .image'
```

If the output looks as follows ```"hashicorp/consul-api-gateway:0.1.0"```, continue following this upgrade path.

**2.** Run the following command to retrieve all routes defined with a cross namespace:

```kubectl get HttpRoute -o json -A | jq -r '.items[] | {name: .metadata.name, namespace: .metadata.namespace, kind: .kind, crossNamespaceBackendReferences: ( .metadata.namespace as $parentnamespace | .spec.rules[] .backendRefs[] | select(.namespace != null and .namespace != $parentnamespace )  )}  ' && kubectl get TcpRoute -o json -A | jq -r '.items[] | {name: .metadata.name, namespace: .metadata.namespace, kind: .kind, crossNamespaceBackendReferences: ( .metadata.namespace as $parentnamespace | .spec.rules[] .backendRefs[] | select(.namespace != null and .namespace != $parentnamespace )  )}  '
```

Note, the above command will retrieve all HTTPRoutes and TCPRoutes. TLSRoutes and UDPRoutes are not supported in v0.1.0

If you have any breaking namespaces, your output will something like as follows. If your output is empty, you have no breaking routes and you can skip to the last step.

```
{
  "name": "example-breaking-http-route",
  "namespace": "example-namespace",
  "kind": "HTTPRoute",
  "crossNamespaceBackendReferences": {
    "group": "",
    "kind": "Service",
    "name": "web-backend",
    "namespace": "gateway-namespace",
    "port": 8080,
    "weight": 1
  }
}
{
  "name": "example-breaking-tcp-route",
  "namespace": "a-different-namespace",
  "kind": "TCPRoute",
  "crossNamespaceBackendReferences": {
    "group": "",
    "kind": "Service",
    "name": "web-backend",
    "namespace": "gateway-namespace",
    "port": 8080,
    "weight": 1
  }
}
```

**3.** Create a ReferencePolicy to allow cross namespace traffic.

Using the above output as a guide, create a [ReferencePolicy](https://gateway-api.sigs.k8s.io/v1alpha2/references/spec/#gateway.networking.k8s.io/v1alpha2.ReferencePolicy) to allow cross namespace traffic. If you've already created a ReferencePolicy you can skip this step.

For example, the above output would require a reference policy that looks follows.

Note, the ReferencePolicy should be created in the same namespace that its allowing traffic to

<CodeBlockConfig filename="referencepolicy.yaml">


apiVersion: gateway.networking.k8s.io/v1alpha2
kind: ReferencePolicy
metadata:
  name: reference-policy
  namespace: gateway-namespace
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: example-namespace
    - group: gateway.networking.k8s.io
      kind: TCPRoute
      namespace: a-different-namespace
  to:
    - group: ""
      kind: Service
      name: web-backend
</CodeBlockConfig>

Edit your ReferencePolicy so all routes are allowed and save into a file called referencepolicy.yaml

Run the following command to apply it to your cluster

```
kubectl apply -f referencepolicy.yaml
```

**4.** Upgrade your deployment to v.0.2.0.
```
kubectl set image deployments/consul-api-gateway-controller -n consul api-gateway-controller=hashicorp/consul-api-gateway:0.2.0

```

## Post-Upgrade Configuration Changes

No configuration changes are required for this upgrade.
